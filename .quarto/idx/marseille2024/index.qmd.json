{"title":"Differentiable and distributed Particle-Mesh n-body simulations","markdown":{"yaml":{"title":"Differentiable and distributed Particle-Mesh n-body simulations","author":"Wassim Kabalan","title-slide-attributes":{"data-background-image":"assets/lsst_bg.jpg","data-background-size":"fill","data-background-opacity":"0.5"}},"headingText":"the $\\Lambda$CDM view of the universe","containsRefs":false,"markdown":"\n\n\n:::: {.columns}\n\n::: {.column width=\"60%\"}\n\n::: {.fragment}\n\n<div style=\"text-align: center;\">\n  ![lambda CMD model](assets/LCDM.png)\n</div>\n\n:::\n\n:::\n\n::: {.column width=\"40%\"}\n\n::: {.fragment}\n\n<br />\n<br />\n\n### Cosmological Parameters:\n\n- Physical baryon density $\\Omega_b$\n- Physical dark matter density $\\Omega_{cdm}$\n- The age of the universe $t_0$\n- Scalar spectral index $n_s$\n- Curvature fluctuation amplitude $A_s$\n- Reionization optical depth $\\tau$\n\n:::\n:::\n\n::::\n\n---\n\n## Cosmological probes {background-image=\"assets/wl.jpeg\"}\n\n\n::: {.fragment}\n\n<br />\n<br />\n<br />\n<br />\n<br />\n<br />\n<br />\n<br />\n\n:::{.solutionbox}\n\n::::{.solutionbox-header}\n\nWeak Gravitaional Lensing\n\n:::::\n\n::::{.solutionbox-body} \n\n$$ \\boxed{e = \\gamma + e_i} $$\n ➢  &emsp;With $\\gamma$ representing the shear and $e_i$ representing the intrinsic ellipticity, distributed as $\\mathcal{N}(0, I)$\\\n ➢  &emsp;We use the shear as as probe of dark matter distribution\n\n::::\n\n\n:::\n:::\n\n---\n\n\n## Traditional cosmological inference\n\n:::: {.columns}\n\n::: {.column width=\"40%\"}\n\n::: {.fragment .fade-in-then-out fragment-index=1}\n![](assets/alonso-g1.png){.absolute top=50 left=0 width=\"400\"}\n\n![](assets/alonso-g2.png){.absolute top=250 left=0 width=\"400\"}\n:::\n\n::: {.fragment .fade-in-then-out fragment-index=1}\n::: {.fragment .fade-in-then-out fragment-index=3}\n![](assets/hsc_constraints.png){.absolute top=75 left=25 width=\"350\"}\n(Hikage et al. 2018)\n:::\n:::\n\n::: {.fragment .fade-in-then-out fragment-index=2}\n![](assets/hsc-corr-function.png){.absolute top=75 left=25 width=\"300\"}\n:::\n\n::: {.fragment fragment-index=3}\n![](assets/hsc_constraints.png){.absolute top=75 left=25 width=\"350\"}\n:::\n\n::: {.fragment fragment-index=1}\n::: aside\n(Hikage et al. 2018)\n:::\n:::\n\n:::\n\n::: {.column width=\"60%\"}\n\n::: {.fragment fragment-index=1}\n<br />\n<br />\n ➢  &emsp;Measure the ellipticity $e = \\gamma + e_i$ of all galaxies\n:::\n\n::: {.fragment fragment-index=2}\n<br />\n<br />\n ➢  &emsp;Compute **summary statistics** based on the 2-point correlation function of the shear field\n:::\n\n::: {.fragment fragment-index=3}\n<br />\n<br />\n ➢  &emsp;Run an **MCMC** chain to recover the posterior distribution of the cosmological parameters, using an **analytical likelihood**\n  $$p(\\theta | x ) \\propto \\underbrace{p(x | \\theta)}_{\\mathrm{likelihood}} \\ \\underbrace{p(\\theta)}_{\\mathrm{prior}}$$\n\n:::\n\n:::\n\n::::\n\n::: {.fragment fragment-index=4}\n\n:::{.solutionbox}\n\n::::{.solutionbox-header}\nLimitations\n::::\n\n::::{.solutionbox-body}\n- Simple summary statistics works well for Gaussian fields\n- The need to compute from theory the likelihood for simple summary statistics\n::::\n\n:::\n\n:::\n\n---\n\n### Beyond 2 point statistics : Forward modeling\n\n<br />\n\n![](assets/simu.png){.nostretch fig-align=\"center\" width=\"600px\"}\n\n\n::: {.fragment}\n\n➕  &emsp;No longer need to compute the likelihood analytically\n<br />\n<br />\n➖ &emsp;We need to infer the joint posterior $p(\\theta, z | x)$ before marginalization to get $p(\\theta | x) = \\int p(\\theta, z | x) \\, dz$\n\n::: \n\n::: {.fragment}\n\n:::{.solutionbox}\n\n\n::::{.solutionbox-header}\nPossible solutions\n::::\n\n::::{.solutionbox-body}\n- **Hamiltonian Monte Carlo**\n- **Variational Inference**\n- **Dimensionality reduction using Fisher Information Matrix**\n\n*All require a differentiable fast forward model*\n\n::::\n\n:::\n\n:::\n\n---\n\n### Forward Models in Cosmology\n\n<br />\n<br />\n\n::: {style=\"text-align: center;\"}\n\n::: {.columns}\n\n::: {.column width=\"25%\" .fragment fragment-index=1}\n![Initial Conditions](assets/field-init.png )\n:::\n::: {.column width=\"25%\" .fragment fragment-index=2}\n![Final Dark Matter](assets/field-init.png)\n\n:::\n::: {.column width=\"25%\" .fragment fragment-index=3}\n![Linear field](assets/field-init.png)\n:::\n::: {.column width=\"25%\" .fragment fragment-index=3}\n![Linear field](assets/field-init.png)\n:::\n\n:::\n\n:::\n\n---\n\n### Cosmological simulations WIP\n\n![](assets/image-9.png)\n\n---\n\n### Fast Particle-Mesh WIP\n\nHaving a full n body simulation is very expensive, so we use a particle mesh simulation\n\nThe idea is to put particles in a grid and evolve the particles in the grid\n\nyou lose some precision on the small scales, but on the large scale it is pretty accurate.\n\nNumerical cheme\n\nCloud in Cell binning\n\n\n![alt text](assets/image-10.png)\n\n\n![alt text](assets/image-11.png)\n\nwhen we have the forces on the grid point we interpolate the forces on the particles\n\n![alt text](assets/image-12.png)\n\n---\n\n### Where does LSST fit into this WIP\n\nRubin observatory will provide us with a 15 TB of data per night for 10 years\n\nsay that we need to make a cube of big part of the volume of the survey.\n\nPicture of a 3D force vector field\n\nHigh end GPUs have a reached 80 GBs A100 next generation H100\n\n---\n\n### Problems to consider WIP\n\n - Diffrentability\n - Fast GPU\n - Distribution of the data\n - Multi Host distribution\n\nJAX \n\n---\n\n### JAXDECOMP WIP\n\nexample of numpy code and grad\n\nwe can also run multiple devices in a single controlle set up\n\n80 w=x 80\n\nDifferentiable multi host distributed n body simulation that runs on GPUs\n\nRelated work\n\nFastPM\nPoqueres nbody 64^3\npmwd 512^3\n\n---\n\n### JAXPM WIP\n\nbuilt on top of JAXDECOMP\n\nexample code of JAXPM\n\nThree steps\n\nGenerate the linear field\n\nthen LPT simulation \n\nthen the final nbody simulation (use any differential equation solver like diffrax)\n\nFinally we put the final grid back to the particles\n\n---\n\n### AutoDiff capabilities WIP\n\nWe can simply differentiate the entire simulation using jax.grad\n\nWe can also interface it with machine learning frameworks like flax for the dark matter halo painting and galaxy painting\n\n---\n\n### Benchmark  WIP\n\n\n\n### Animation WIP\n\nUnique solutions : no, two particles crossing each other yoy can't tell which one is which\n\n","srcMarkdownNoYaml":"\n\n## the $\\Lambda$CDM view of the universe\n\n:::: {.columns}\n\n::: {.column width=\"60%\"}\n\n::: {.fragment}\n\n<div style=\"text-align: center;\">\n  ![lambda CMD model](assets/LCDM.png)\n</div>\n\n:::\n\n:::\n\n::: {.column width=\"40%\"}\n\n::: {.fragment}\n\n<br />\n<br />\n\n### Cosmological Parameters:\n\n- Physical baryon density $\\Omega_b$\n- Physical dark matter density $\\Omega_{cdm}$\n- The age of the universe $t_0$\n- Scalar spectral index $n_s$\n- Curvature fluctuation amplitude $A_s$\n- Reionization optical depth $\\tau$\n\n:::\n:::\n\n::::\n\n---\n\n## Cosmological probes {background-image=\"assets/wl.jpeg\"}\n\n\n::: {.fragment}\n\n<br />\n<br />\n<br />\n<br />\n<br />\n<br />\n<br />\n<br />\n\n:::{.solutionbox}\n\n::::{.solutionbox-header}\n\nWeak Gravitaional Lensing\n\n:::::\n\n::::{.solutionbox-body} \n\n$$ \\boxed{e = \\gamma + e_i} $$\n ➢  &emsp;With $\\gamma$ representing the shear and $e_i$ representing the intrinsic ellipticity, distributed as $\\mathcal{N}(0, I)$\\\n ➢  &emsp;We use the shear as as probe of dark matter distribution\n\n::::\n\n\n:::\n:::\n\n---\n\n\n## Traditional cosmological inference\n\n:::: {.columns}\n\n::: {.column width=\"40%\"}\n\n::: {.fragment .fade-in-then-out fragment-index=1}\n![](assets/alonso-g1.png){.absolute top=50 left=0 width=\"400\"}\n\n![](assets/alonso-g2.png){.absolute top=250 left=0 width=\"400\"}\n:::\n\n::: {.fragment .fade-in-then-out fragment-index=1}\n::: {.fragment .fade-in-then-out fragment-index=3}\n![](assets/hsc_constraints.png){.absolute top=75 left=25 width=\"350\"}\n(Hikage et al. 2018)\n:::\n:::\n\n::: {.fragment .fade-in-then-out fragment-index=2}\n![](assets/hsc-corr-function.png){.absolute top=75 left=25 width=\"300\"}\n:::\n\n::: {.fragment fragment-index=3}\n![](assets/hsc_constraints.png){.absolute top=75 left=25 width=\"350\"}\n:::\n\n::: {.fragment fragment-index=1}\n::: aside\n(Hikage et al. 2018)\n:::\n:::\n\n:::\n\n::: {.column width=\"60%\"}\n\n::: {.fragment fragment-index=1}\n<br />\n<br />\n ➢  &emsp;Measure the ellipticity $e = \\gamma + e_i$ of all galaxies\n:::\n\n::: {.fragment fragment-index=2}\n<br />\n<br />\n ➢  &emsp;Compute **summary statistics** based on the 2-point correlation function of the shear field\n:::\n\n::: {.fragment fragment-index=3}\n<br />\n<br />\n ➢  &emsp;Run an **MCMC** chain to recover the posterior distribution of the cosmological parameters, using an **analytical likelihood**\n  $$p(\\theta | x ) \\propto \\underbrace{p(x | \\theta)}_{\\mathrm{likelihood}} \\ \\underbrace{p(\\theta)}_{\\mathrm{prior}}$$\n\n:::\n\n:::\n\n::::\n\n::: {.fragment fragment-index=4}\n\n:::{.solutionbox}\n\n::::{.solutionbox-header}\nLimitations\n::::\n\n::::{.solutionbox-body}\n- Simple summary statistics works well for Gaussian fields\n- The need to compute from theory the likelihood for simple summary statistics\n::::\n\n:::\n\n:::\n\n---\n\n### Beyond 2 point statistics : Forward modeling\n\n<br />\n\n![](assets/simu.png){.nostretch fig-align=\"center\" width=\"600px\"}\n\n\n::: {.fragment}\n\n➕  &emsp;No longer need to compute the likelihood analytically\n<br />\n<br />\n➖ &emsp;We need to infer the joint posterior $p(\\theta, z | x)$ before marginalization to get $p(\\theta | x) = \\int p(\\theta, z | x) \\, dz$\n\n::: \n\n::: {.fragment}\n\n:::{.solutionbox}\n\n\n::::{.solutionbox-header}\nPossible solutions\n::::\n\n::::{.solutionbox-body}\n- **Hamiltonian Monte Carlo**\n- **Variational Inference**\n- **Dimensionality reduction using Fisher Information Matrix**\n\n*All require a differentiable fast forward model*\n\n::::\n\n:::\n\n:::\n\n---\n\n### Forward Models in Cosmology\n\n<br />\n<br />\n\n::: {style=\"text-align: center;\"}\n\n::: {.columns}\n\n::: {.column width=\"25%\" .fragment fragment-index=1}\n![Initial Conditions](assets/field-init.png )\n:::\n::: {.column width=\"25%\" .fragment fragment-index=2}\n![Final Dark Matter](assets/field-init.png)\n\n:::\n::: {.column width=\"25%\" .fragment fragment-index=3}\n![Linear field](assets/field-init.png)\n:::\n::: {.column width=\"25%\" .fragment fragment-index=3}\n![Linear field](assets/field-init.png)\n:::\n\n:::\n\n:::\n\n---\n\n### Cosmological simulations WIP\n\n![](assets/image-9.png)\n\n---\n\n### Fast Particle-Mesh WIP\n\nHaving a full n body simulation is very expensive, so we use a particle mesh simulation\n\nThe idea is to put particles in a grid and evolve the particles in the grid\n\nyou lose some precision on the small scales, but on the large scale it is pretty accurate.\n\nNumerical cheme\n\nCloud in Cell binning\n\n\n![alt text](assets/image-10.png)\n\n\n![alt text](assets/image-11.png)\n\nwhen we have the forces on the grid point we interpolate the forces on the particles\n\n![alt text](assets/image-12.png)\n\n---\n\n### Where does LSST fit into this WIP\n\nRubin observatory will provide us with a 15 TB of data per night for 10 years\n\nsay that we need to make a cube of big part of the volume of the survey.\n\nPicture of a 3D force vector field\n\nHigh end GPUs have a reached 80 GBs A100 next generation H100\n\n---\n\n### Problems to consider WIP\n\n - Diffrentability\n - Fast GPU\n - Distribution of the data\n - Multi Host distribution\n\nJAX \n\n---\n\n### JAXDECOMP WIP\n\nexample of numpy code and grad\n\nwe can also run multiple devices in a single controlle set up\n\n80 w=x 80\n\nDifferentiable multi host distributed n body simulation that runs on GPUs\n\nRelated work\n\nFastPM\nPoqueres nbody 64^3\npmwd 512^3\n\n---\n\n### JAXPM WIP\n\nbuilt on top of JAXDECOMP\n\nexample code of JAXPM\n\nThree steps\n\nGenerate the linear field\n\nthen LPT simulation \n\nthen the final nbody simulation (use any differential equation solver like diffrax)\n\nFinally we put the final grid back to the particles\n\n---\n\n### AutoDiff capabilities WIP\n\nWe can simply differentiate the entire simulation using jax.grad\n\nWe can also interface it with machine learning frameworks like flax for the dark matter halo painting and galaxy painting\n\n---\n\n### Benchmark  WIP\n\n\n\n### Animation WIP\n\nUnique solutions : no, two particles crossing each other yoy can't tell which one is which\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.551","title":"Differentiable and distributed Particle-Mesh n-body simulations","author":"Wassim Kabalan","title-slide-attributes":{"data-background-image":"assets/lsst_bg.jpg","data-background-size":"fill","data-background-opacity":"0.5"}},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}